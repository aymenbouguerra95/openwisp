version: '3.8'

services:
  db:
    image: postgres:13  # Using the official image from Docker Hub
    restart: always
    environment:
      POSTGRES_DB: openwisp
      POSTGRES_USER: openwispuser
      POSTGRES_PASSWORD: openwisp_password
    volumes:
      - db-data:/var/lib/postgresql/data  # Persistent volume for PostgreSQL

  server:
    build: .
    image: aymenbouguerra/openwisp-server:v1  # Tag for the server changed to v1
    restart: always
    ports:
      - "8000:8000"  # Port mapping for the server service
    environment:
      DATABASE_URL: postgres://openwispuser:openwisp_password@db:5432/openwisp
    depends_on:
      - db
    volumes:
      - static_data:/app/static  # Persistent volume for static files

  nginx:
    image: nginx:latest  # Using the official image from Docker Hub
    restart: always
    ports:
      - "80:80"  # Exposing Nginx on port 80
    volumes:
      - static_data:/app/static  # Same persistent volume for Nginx
      - ./nginx.conf:/etc/nginx/conf.d/default.conf  # Local nginx.conf
    depends_on:
      - server

volumes:
  db-data:  # Persistent volume for the database
  static_data:  # Persistent volume for static files
